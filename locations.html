<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vahid Elektrikdoldurma Platforması</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.5/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.5/ol.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

</head>
<body>
     <!-- Navbar -->
     <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="./index.html">
                <img src="./images/Logo_azerishiq.png" alt="Logo" class="me-2">
                <span style="color: #D1B180;">Vahid Elektrikdoldurma Platforması</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav w-100 d-flex justify-content-between align-items-center">
                    <!-- Sol tərəfdə olan elementlər -->
                    
            
                    <!-- Ortada olan elementlər -->
                    <div class="d-flex justify-content-center flex-grow-1">
                        <li class="nav-item mx-3">
                            <!-- <a class="nav-link" href="./tariff.html">Şirkətlər və Tariflər</a> -->
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link" href="./locations.html">Məntəqələr</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link" href="./about.html">Haqqımızda</a>
                        </li>
                    </div>
                    <li class="nav-item">
                        <a  class="nav-link" href="#"><i style="color: #D1B180;" class="bi bi-globe2"></i> AZ</a>
                    </li>
                    <li class="nav-item">
                        <a  class="nav-link" href="#"><i style="color: #D1B180;" class="bi bi-telephone"></i> 199</a>
                    </li>
                </ul>
            </div>
            
        </div>
    </nav>
    
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="edm-heading">EDC-lərin mövcud vəziyyəti</h3> 
            <div class="input-group" style="width: 306px;">
                <input type="text" class="form-control" placeholder="" aria-label="search">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="row">
                    <div class="col-9">
                        <div class="location-table">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th style="color: #656565;">EDM Nº</th>
                                        <th>Başlığın modeli</th>
                                        <th>Ünvan</th>
                                        <th>Koordinantları</th>
                                        <th>Statusu</th>
                                        <th>İstifadə sayı</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>00000001</td>
                                        <td>CXE-D120</td>
                                        <td> İçərişəhər Y/S <br>
                                        <span class="district">Səbail rayonu</span>
                                        </td>
                                        <td>4486070.48 + 400974.81</td>
                                        <td><span class="badge bg-success w-100">istifadəyə hazır</span></td>
                                        <td class="status-cell" onclick="handleClick(this)">1
                                            <img class="icon-loc" src="./images/iconlocation.png" alt="">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>00000002</td>
                                        <td>CXE-D120</td>
                                        <td>İçərişəhər Y/S <br>
                                        <span class="district">Səbail rayonu</span>
                                        </td>
                                        <td>4486070.83 + 400977.84</td>
                                        <td><span class="badge bg-danger w-100">istifadədədir</span></td>
                                        <td class="status-cell" onclick="handleClick(this)">1
                                            <img class="icon-loc" src="./images/iconlocation.png" alt="">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>00000003</td>
                                        <td>SC30750HGO</td>
                                        <td> Azərişıq Tədris Mərkəzi <br>
                                        <span class="district">Nərimanov rayonu</span>
                                        </td>
                                        <td>4472653.38 + 402286.09</td>
                                        <td><span class="badge bg-success w-100 ">istifadəyə hazır</span></td>
                                        <td class="status-cell" onclick="handleClick(this)">3
                                            <img class="icon-loc" src="./images/iconlocation.png" alt="">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>00000004</td>
                                        <td>SC30750HGO</td>
                                        <td> Ağ şəhər-1 YS <br>
                                        <span class="district">Xətai rayonu</span>
                                        </td>
                                        <td>4470287.91 + 405938.33</td>
                                        <td><span class="badge bg-warning w-100 text-dark">quraşdırılır</span></td>
                                        <td class="status-cell" onclick="handleClick(this)">0
                                            <img  class="icon-loc" src="./images/iconlocation.png" alt="">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>00000005</td>
                                        <td>SC30750HGO</td>
                                        <td> Ağ şəhər-1 YS <br>
                                        <span class="district">Xətai rayonu</span>
                                        </td>
                                        <td>4470298.02 +405938.68</td>
                                        <td><span class="badge bg-warning w-100 text-dark">quraşdırılır</span></td>
                                        <td class="status-cell" onclick="handleClick(this)">0
                                            <img class="icon-loc" src="./images/iconlocation.png" alt="">
                                        </td>
                                    </tr>
                                </tbody>
                            </table> 
                        </div>
                    </div>
                    <div class="col-3"> 
                        
                        <div class="card text-center">
                            <div class="card-header " >
                                <h3>Hal hazırki status</h3>
                            </div>
                            <div class="card-body">
                                <td class="status-container">
                                    <div id="chart"></div>
                                </td> 
                            </div>
                        </div> 
                    </div>
                </div>  
            </div>
            <div class="col-12 my-5">
                <div id="map"></div>
                <div id="popup" class="ol-popup">
                    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                    <div id="popup-content" class="popup-content"></div>
                </div>
                <div id="loading" class="loading-indicator">Məlumatlar yüklənir...</div>
            </div>
        </div>   
    </div>

  <!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4 mb-lg-0">
                <img src="./images/Logo_azerisig.png" alt="Azərisiq Logo" class="footer-logo">
                <p>Vahid Elektrikdoldurma Platforması</p>
                <div class="d-flex mt-3">
                    <a href="#" class="me-2"><img style="width: 118px;" src="./images/googleplay (1).png" alt="Google Play"></a>
                    <a href="#"><img style="width: 118px;" src="./images/app (1).png" alt="App Store"></a>
                </div>
            </div>
            <div class="col-lg-8 pt-3">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <h5>HAQQIMIZDA</h5>
                        <ul class="list-unstyled d-flex flex-column gap-2">
                            <li><a href="#">Məntəqələr</a></li>
                            <li><a href="#">Yeniliklər</a></li>
                            <li><a href="./faq.html">Tez-tez Verilən Suallar</a></li>
                        </ul>
                    </div>
                    <div class="col-md-4 mb-4">
                        <h5>Şirkətlər & Tariflər</h5>
                        <ul class="list-unstyled d-flex flex-column gap-2">
                            <li><a href="#">Charge.az</a></li>
                            <li><a href="#">Yeniliklər</a></li>
                        </ul>
                    </div>
                    <div class="col-md-4 mb-4">
                        <h5>Əlaqə</h5>
                        <ul class="list-unstyled d-flex flex-column gap-2">
                            <li><a href="tel:+994124853903"><i class="bi bi-telephone me-2"></i>+994 12 546 03 03</a></li>
                            <li><a href="#"><i class="bi bi-geo-alt me-2"></i>Mirzə Ağa Əliyev</a></li>
                            <li><a href="mailto:info@azeriisig.az"><i class="bi bi-envelope me-2"></i>vep@azerishiq.az</a></li>
                            <li><a href="#"><i class="bi bi-building me-2"></i>199 Çağrı mərkəzi</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom text-center">
            <p>2022 Azərisiq.az © Bütün hüquqlar qorunur</p>
        </div>
    </div>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
//  Chart
var options = {
          series: [44, 55, 13],
          chart: {
          width: '100%',
          type: 'pie',
        },
        labels: ['Quraşdırılır', 'Hazır', 'İstifadədə'],
        colors: ['#FFBB33', '#00C851', '#E55934'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: '100%'
            },
          }
        }],
        legend: {
    position: 'bottom',
    // horizontalAlign: 'center', 
    floating: false,
    offsetY: 0 
  }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

document.addEventListener('DOMContentLoaded', function() {
            const loadingIndicator = document.getElementById('loading');
            
            const map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([49.85, 40.40]),
                    zoom: 12
                })
            });

            const vectorSource = new ol.source.Vector();
            const clusterSource = new ol.source.Cluster({
                distance: 40,
                source: vectorSource
            });
            
            const styleCache = {};
            const styleFunction = function(feature) {
                const size = feature.get('features').length;
                let style = styleCache[size];
                
                if (!style) {
                    const radius = Math.min(Math.max(10, size * 5), 30);
                    
                    style = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius,
                            fill: new ol.style.Fill({
                                color: size > 1 ? 'rgba(241, 128, 23, 0.8)' : 'rgba(0, 176, 80, 0.8)'
                            }),
                            stroke: new ol.style.Stroke({
                                color: '#fff',
                                width: 2
                            })
                        }),
                        text: new ol.style.Text({
                            text: size.toString(),
                            fill: new ol.style.Fill({
                                color: '#fff'
                            }),
                            font: 'bold 12px Arial'
                        })
                    });
                    
                    styleCache[size] = style;
                }
                
                return style;
            };

            const clusterLayer = new ol.layer.Vector({
                source: clusterSource,
                style: styleFunction
            });
            
            map.addLayer(clusterLayer);

            const container = document.getElementById('popup');
            const content = document.getElementById('popup-content');
            const closer = document.getElementById('popup-closer');

            const overlay = new ol.Overlay({
                element: container,
                autoPan: {
                    animation: {
                        duration: 250
                    }
                }
            });
            
            map.addOverlay(overlay);

            closer.onclick = function() {
                overlay.setPosition(undefined);
                closer.blur();
                return false;
            };

            map.on('pointermove', function(evt) {
                const hit = map.hasFeatureAtPixel(evt.pixel);
                map.getTargetElement().style.cursor = hit ? 'pointer' : '';
            });

            map.on('click', function(evt) {
                const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                    return feature;
                });
                
                if (feature) {
                    const features = feature.get('features');
                    
                    if (features && features.length > 1) {
                        if (map.getView().getZoom() < 18) {
                            const view = map.getView();
                            view.animate({
                                zoom: view.getZoom() + 2,
                                duration: 250,
                                center: evt.coordinate
                            });
                        } else {
                            showPopup(features[0], evt.coordinate);
                        }
                    } else if (features && features.length === 1) {
                        showPopup(features[0], evt.coordinate);
                    }
                } else {
                    overlay.setPosition(undefined);
                }
            });

            function showPopup(feature, coordinate) {
                const name = feature.get('name');
                const address = feature.get('address');
                const accessDescription = feature.get('accessDescription');
                const connectorsCount = feature.get('connectorsCount');
                const providerDescription = feature.get('providerDescription');
                
                let popupHTML = `
                    <h3>${name}</h3>
                    <p><span class="detail-label">Adres:</span> ${address}</p>
                    <p><span class="detail-label">Giriş:</span> ${accessDescription}</p>
                    <p><span class="detail-label">Bağlantı sayı:</span> ${connectorsCount}</p>
                `;
                
                if (providerDescription) {
                    popupHTML += `<p><span class="detail-label">Şirkət:</span> ${providerDescription}</p>`;
                }
                
                content.innerHTML = popupHTML;
                overlay.setPosition(coordinate);
            }

            async function loadDataFromAPI() {
                try {
                    loadingIndicator.style.display = 'block';
                    const response = await fetch('https://edm-prod1.azerishiq.az/api/resources/v2/chargings');
            
                    if (!response.ok) {
                        throw new Error(`Şəbəkədə xata var: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    loadingIndicator.style.display = 'none';
                    return data;
                } catch (error) {
                    console.error('Şəbəkədə xata var:', error);
                    loadingIndicator.textContent = 'Şəbəkədə xata var: ' + error.message;
                    return { data: [] };
                }
            }
            
            loadDataFromAPI().then(apiData => {
                if (apiData && apiData.data && Array.isArray(apiData.data)) {
                    apiData.data.forEach(location => {
                        if (location.latitude && location.longitude) {
                            const feature = new ol.Feature({
                                geometry: new ol.geom.Point(ol.proj.fromLonLat([location.longitude, location.latitude])),
                                id: location.id,
                                name: location.name || '',
                                address: location.address || '',
                                accessDescription: location.accessDescription || '',
                                providerDescription: location.providerDescription || '',
                                connectorsCount: location.connectors ? location.connectors.length : 0
                            });
                            
                            vectorSource.addFeature(feature);
                        }
                    });
                    
                    if (vectorSource.getFeatures().length > 0) {
                        const extent = vectorSource.getExtent();
                        map.getView().fit(extent, {
                            padding: [50, 50, 50, 50],
                            maxZoom: 14
                        });
                    }
                } else {
                    loadingIndicator.textContent = 'API xətası';
                    console.error('API xətası:', apiData);
                }
            }).catch(error => {
                loadingIndicator.textContent = 'API xətası: ' + error.message;
                console.error('API xətası:', error);
            });
        });



//  map

    //      var map = L.map('map').setView([40.4093, 49.8671], 12);
 
    //      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //          attribution: '&copy; OpenStreetMap contributors'
    //      }).addTo(map);
 
    //      var edms = [
    //          { id: "00000001", model: "CXE-D120", address: "İçərişəhər Y/S, Səbail rayonu", coords: [40.3661, 49.8351], status: "istifadəyə hazır", usage: 1 },
    //          { id: "00000002", model: "CXE-D120", address: "İçərişəhər Y/S, Səbail rayonu", coords: [40.3672, 49.8375], status: "istifadədədir", usage: 1 },
    //          { id: "00000003", model: "SC30750HGO", address: "Azərişıq Tədris Mərkəzi, Nərimanov rayonu", coords: [40.4003, 49.8751], status: "istifadəyə hazır", usage: 3 },
    //          { id: "00000004", model: "SC30750HGO", address: "Ağ şəhər-1 YS, Xətai rayonu", coords: [40.3907, 49.8956], status: "quraşdırılır", usage: 0 },
    //          { id: "00000005", model: "SC30750HGO", address: "Ağ şəhər-1 YS, Xətai rayonu", coords: [40.3918, 49.8959], status: "quraşdırılır", usage: 0 }
    //      ];

 
    //     var tableBody = document.getElementById("edm-table-body");
         
    //      edms.forEach(edm => {
    //          var row = `<tr>
    //              <td>${edm.id}</td>
    //              <td>${edm.model}</td>
    //              <td>${edm.address}</td>
    //              <td>${edm.coords.join(", ")}</td>
    //              <td>${edm.status}</td>
    //              <td>${edm.usage}</td>
    //          </tr>`;
    //          tableBody.innerHTML += row;
 
    //          L.marker(edm.coords)
    //              .addTo(map)
    //              .bindPopup(`<b>${edm.model}</b><br>${edm.address}<br><b>Status:</b> ${edm.status}`);
    //      });

    //      function handleClick(element) {
    //     element.classList.add("clicked");
    //     setTimeout(() => {
    //         element.classList.remove("clicked"); 
    //     }, 300);
    // }
     </script>
    
</body>
</html>